# üîê OIDC Setup Guide for Terraform Deployment to AWSnnThis guide will help you set up OpenID Connect (OIDC) authentication between GitHub Actions and AWS for secure Terraform deployments.nn## üìã Prerequisitesnn- AWS CLI configured with appropriate permissionsn- GitHub repository: `Rajmate16/book-review-portal`n- Terraform installed locally (for testing)nn## üöÄ Step-by-Step Setupnn### Step 1: Create AWS OIDC Identity Providernn```bashn# Create OIDC Identity Provider for GitHub Actionsnaws iam create-open-id-connect-provider \n  --url https://token.actions.githubusercontent.com \n  --client-id-list sts.amazonaws.com \n  --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1n```nn### Step 2: Create IAM Policy for Terraform Executionnn```bashn# Create the IAM policy for Terraform permissionsnaws iam create-policy \n  --policy-name TerraformExecutionPolicy \n  --policy-document file://terraform-execution-policy.jsonn```nn### Step 3: Create IAM Role with Trust PolicynnFirst, update the `aws-oidc-trust-policy.json` file with your AWS account ID:nn```bashn# Replace YOUR_AWS_ACCOUNT_ID with your actual AWS account IDn# You can find your account ID with: aws sts get-caller-identity --query Account --output textn```nnThen create the role:nn```bashn# Create IAM role with trust policynaws iam create-role \n  --role-name GitHubActionsTerraformRole \n  --assume-role-policy-document file://aws-oidc-trust-policy.jsonn```nn### Step 4: Attach Policy to Rolenn```bashn# Attach the Terraform execution policy to the rolenaws iam attach-role-policy \n  --role-name GitHubActionsTerraformRole \n  --policy-arn arn:aws:iam::YOUR_AWS_ACCOUNT_ID:policy/TerraformExecutionPolicyn```nn### Step 5: Create S3 Bucket for Terraform Statenn```bashn# Create S3 bucket for Terraform statenaws s3 mb s3://book-review-portal-terraform-state --region us-east-1nn# Enable versioningnaws s3api put-bucket-versioning \n  --bucket book-review-portal-terraform-state \n  --versioning-configuration Status=Enablednn# Enable encryptionnaws s3api put-bucket-encryption \n  --bucket book-review-portal-terraform-state \n  --server-side-encryption-configuration '{n    "Rules": [n      {n        "ApplyServerSideEncryptionByDefault": {n          "SSEAlgorithm": "AES256"n        }n      }n    ]n  }'n```nn### Step 6: Get Role ARNnn```bashn# Get the role ARN to use in GitHub secretsnaws iam get-role --role-name GitHubActionsTerraformRole --query 'Role.Arn' --output textn```nn### Step 7: Configure GitHub Repository SecretsnnIn your GitHub repository (`https://github.com/Rajmate16/book-review-portal`):nn1. Go to **Settings ‚Üí Secrets and variables ‚Üí Actions**n2. Click **New repository secret**n3. Add the following secrets:nn| Secret Name | Value |n|-------------|-------|n| `AWS_ROLE_ARN` | `arn:aws:iam::YOUR_AWS_ACCOUNT_ID:role/GitHubActionsTerraformRole` |n| `TF_VAR_db_password` | `MySecurePassword123!` (or your preferred secure password) |nn## üîÑ GitHub Actions WorkflownnThe workflow file `.github/workflows/terraform-deploy.yml` is already configured with:nn- **Triggers**: Push to main/develop branches, pull requests, manual dispatchn- **OIDC Authentication**: Uses `aws-actions/configure-aws-credentials@v4` with role assumptionn- **Terraform Operations**: Init, validate, plan, apply, destroyn- **Artifacts**: Uploads and downloads Terraform plans between jobsnn## üß™ Testing the Setupnn### Manual Testingnn1. **Test OIDC Authentication**:n   ```bashn   # Test if the role can be assumedn   aws sts assume-role-with-web-identity \n     --role-arn arn:aws:iam::YOUR_AWS_ACCOUNT_ID:role/GitHubActionsTerraformRole \n     --role-session-name test-session \n     --web-identity-token "test-token"n   ```nn2. **Test Terraform Locally**:n   ```bashn   cd terraformn   terraform initn   terraform plann   ```nn### GitHub Actions Testingnn1. **Manual Trigger**: Go to Actions tab and manually trigger the workflown2. **Push Trigger**: Make a change to terraform files and push to main branchn3. **Monitor**: Check the workflow logs for any authentication or permission issuesnn## üîç Troubleshootingnn### Common Issuesnn1. **"Access Denied" errors**:n   - Verify the IAM role has correct permissionsn   - Check if the trust policy allows your repositoryn   - Ensure the role ARN is correct in GitHub secretsnn2. **"NoSuchBucket" errors**:n   - Verify the S3 bucket exists: `aws s3 ls s3://book-review-portal-terraform-state`n   - Check bucket permissions and encryption settingsnn3. **"Invalid credentials" errors**:n   - Verify the OIDC provider is created correctlyn   - Check the thumbprint in the OIDC providern   - Ensure the role trust policy is correctnn### Debugging Commandsnn```bashn# Check if OIDC provider existsnaws iam list-open-id-connect-providersnn# Check role permissionsnaws iam list-attached-role-policies --role-name GitHubActionsTerraformRolenn# Test S3 bucket accessnaws s3 ls s3://book-review-portal-terraform-statenn# Get caller identitynaws sts get-caller-identityn```nn## üîí Security Best Practicesnn1. **Principle of Least Privilege**: The IAM policy grants only necessary permissionsn2. **Encryption**: S3 bucket uses AES256 encryptionn3. **Versioning**: S3 bucket has versioning enabled for state file recoveryn4. **OIDC**: Uses short-lived credentials instead of long-term access keysn5. **Repository Scoping**: Trust policy is scoped to specific repositorynn## üìö Additional Resourcesnn- [GitHub Actions OIDC Documentation](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)n- [AWS IAM OIDC Documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html)n- [Terraform AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)nn## ‚úÖ Verification Checklistnn- [ ] OIDC Identity Provider createdn- [ ] IAM Policy created and attached to rolen- [ ] IAM Role with trust policy createdn- [ ] S3 bucket for Terraform state createdn- [ ] GitHub repository secrets configuredn- [ ] Terraform backend configuration updatedn- [ ] GitHub Actions workflow testedn- [ ] Manual deployment testedn- [ ] Automatic deployment testednn## üéØ Next Stepsnn1. Run the AWS CLI commands aboven2. Configure GitHub secretsn3. Test the workflow manuallyn4. Make changes to trigger automatic deploymentn5. Monitor the deployment in AWS Console